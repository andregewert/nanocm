<?php
    /* @var $this \Ubergeek\NanoCm\Module\AdminArticlesModule */
    use Ubergeek\NanoCm\StatusCode;
?>
<div class="container">
    <form>
        <h1>Artikel verwalten</h1>

        <div class="toolbar">
            <span class="left">
                <a id="button_add" class="button" href="/admin/articles/edit/" role="button" title="Artikel hinzuf&uuml;gen">
                    <img src="/ncm/img/fatcow/16/page_add.png" alt="" width="16" height="16" />Neu
                </a>
                <a id="button_edit" class="button" href="javascript:void(0)" role="button" title="Ausgew&auml;hlten Artikel bearbeiten">
                    <img src="/ncm/img/fatcow/16/page_edit.png" alt="" width="16" height="16" />Bearbeiten
                </a>
                <a id="button_lock" class="button" href="javascript:void(0)" role="button" title="Ausgew&auml;hlte Artikel sperren">
                    <img src="/ncm/img/fatcow/16/page_key.png" alt="" width="16" height="16" />Sperren
                </a>
                <a id="button_delete" class="button button-secondary" href="javascript:void(0)" role="button" title="Ausgew&auml;hlte Artikel l&ouml;schen">
                    <img src="/ncm/img/fatcow/16/page_delete.png" alt="" width="16" height="16" />L&ouml;schen
                </a>
            </span>
            <span class="right" style="float: right; vertical-align: middle">
                <img class="spinner" id="toolbar_spinner" src="/ncm/img/spin.gif" />

                <label for="input_searchterm">Suche</label>
                <input id="input_searchterm" type="text" autofocus="autofocus" />

                <label for="select_status" class="spaceleft">Status</label>
                <select id="select_status">
                    <option value="">- Alle -</option>
                    <?php foreach ($this->availableStatusCodes as $code) : ?>
                        <option value="<?php echo $code; ?>"><?php echo StatusCode::convertStatusId($code); ?></option>
                    <?php endforeach; ?>
                </select>

                <a class="button spaceleft" role="button" id="button_refresh" title="Ansicht aktualisieren" href="javascript:void(0)">
                    <img src="/ncm/img/fatcow/16/arrow_refresh.png" alt="" width="16" height="16" />Aktualisieren
                </a>
            </span>
        </div>

        <div id="placeholder_articles" class="placeholder">
            <div class="blanker"></div>
            <div class="content"></div>
        </div>

    </form>
</div>
<script type="text/javascript">
    function Articles() {
        var app = this;

        app.page = 1;

        app.showLoadingIndicator = function() {
            $('#toolbar_spinner').addClass('loading');
            $('.placeholder').addClass('loading');
        };

        app.hideLoadingIndicator = function() {
            $('#toolbar_spinner').removeClass('loading');
            $('.placeholder').removeClass('loading');
        };

        /**
         * Initialisiert EventHandler etc.
         */
        app.init = function() {
            $('#button_refresh').click(function() {
                app.refresh();
            });

            $('#button_edit').click(function() {
                app.editSelected();
            });

            $('#button_lock').click(function() {
                app.lockSelected();
            });

            $('#button_delete').click(function() {
                app.deleteSelected();
            });

            app.refresh();
        };

        /**
         * Aktualisiert die Artikelliste
         * @param page
         */
        app.refresh = function(page) {
            app.showLoadingIndicator();
            if (typeof page === 'undefined') {
                page = app.page;
            }

            $.ajax('/admin/articles/ajax/list', {
                cache:      false,
                type:       'GET',
                dataType:   'HTML',
                data:       {
                    searchterm: $('#input_searchterm').val(),
                    status:     $('#select_status').val(),
                    page:       page
                }
            }).done(function(data) {
                $('#placeholder_articles .content').html(data);
                $('.selectall').click(function() {
                    ncm.toggleAllRowsSelection(this);
                });
            }).always(function() {
                app.hideLoadingIndicator();
            });
        };

        /**
         * Ruft die Bearbeitungsmaske für den ersten ausgewählten Artikel auf
         */
        app.editSelected = function() {
            var id = ncm.getFirstSelectedRowId();
            if (id != null) {
                document.location.href = '/admin/articles/edit/' + id;
            }
        };

        /**
         * Löscht alle ausgewählten Artikel
         */
        app.deleteSelected = function() {
            var ids = ncm.getSelectedRowIds();
            if (ids.length > 0) {
                if (confirm('Wollen Sie die ausgewählten Artikel wirklich löschen?')) {
                    app.showLoadingIndicator();
                    $.ajax('/admin/articles/ajax/delete', {
                        cache: false,
                        type: 'GET',
                        dataType: 'JSON',
                        data: {
                            ids: ids
                        }
                    }).always(function () {
                        app.hideLoadingIndicator();
                        app.refresh();
                    });
                }
            }
        };

        /**
         * Sperrt die ausgewählten Artikel
         */
        app.lockSelected = function()  {
            var ids = ncm.getSelectedRowIds();
            if (ids.length > 0) {
                app.showLoadingIndicator();
                $.ajax('/admin/articles/ajax/lock', {
                    cache:      false,
                    type:       'GET',
                    dataType:   'JSON',
                    data:       {
                        ids: ids
                    }
                }).always(function() {
                    app.hideLoadingIndicator();
                    app.refresh();
                });
            }
        };

        app.init();
    }

    $(document).ready(function() {
        module = new Articles();
    });
</script>